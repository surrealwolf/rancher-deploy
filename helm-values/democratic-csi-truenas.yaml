# Democratic CSI Helm Values for TrueNAS
# Generated from terraform.tfvars
# Host: 192.168.9.10
# Dataset: /mnt/SAS/RKE2
# User: rke2
#
# This file is auto-generated. To update, edit terraform/terraform.tfvars and run:
#   ./scripts/generate-helm-values-from-tfvars.sh
#
# Usage: helm install democratic-csi democratic-csi/democratic-csi -f democratic-csi-truenas.yaml

# CSI Driver Configuration (required by chart)
csiDriver:
  name: truenas-nfs
  enabled: true
  attachRequired: true
  podInfoOnMount: true

# Driver Configuration
driver:
  config:
    driver: freenas-api-nfs
    # Enable debug logging (workaround for issue #394: volume expansion fails with 405)
    # See: https://github.com/democratic-csi/democratic-csi/issues/394
    logLevel: debug
    # HTTP connection to TrueNAS API
    httpConnection:
      protocol: "https"
      host: "192.168.9.10"
      port: 443
      apiKey: "2-PHjhswY0SJKTbWcbK39Q9SdA0bixMTE0HsI1yVkW2e1aR3CkxnrY0GSHjT9FeOGE"
      allowInsecure: true
    # ZFS dataset configuration
    # Note: datasetParentName should be the ZFS dataset name (e.g., "SAS/RKE2"), not the mountpoint
    # The mountpoint path (/mnt/SAS/RKE2) is used for NFS share configuration
    zfs:
      datasetParentName: "SAS/RKE2"
      detachedSnapshotsDatasetParentName: "SAS/RKE2-snapshots"
    # NFS share configuration
    # Note: shareHost is used by freenas-api-nfs driver to set server in volume context
    nfs:
      shareHost: "192.168.9.10"
      shareAlldirs: false
      shareAllowedHosts: []
      shareAllowedNetworks: []
      shareMaprootUser: root
      shareMaprootGroup: root
      shareMapallUser: ""
      shareMapallGroup: ""
# Storage Classes Configuration
# Mount options must be an array (as per democratic CSI examples)
storageClasses:
  # Default NFS storage class
  - name: truenas-nfs
    default: true
    reclaimPolicy: Delete
    volumeBindingMode: Immediate
    allowVolumeExpansion: true
    parameters:
      fsType: "nfs"
      parentDataset: "SAS/RKE2"
      nfsServer: "192.168.9.10"
      # NFS version 4 recommended
      nfsVersion: "4"
    # Using default mount options (no override)

# Controller Configuration
# Note: Using "next" tag for TrueNAS 25+ compatibility (fixes SCALE detection issue)
controller:
  driver:
    image:
      tag: next
  replicas: 1
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi
  # Tolerations for RKE2 server nodes (control-plane and etcd taints)
  tolerations:
    - key: node-role.kubernetes.io/control-plane
      operator: Exists
      effect: NoSchedule
    - key: node-role.kubernetes.io/etcd
      operator: Exists
      effect: NoExecute
    - key: CriticalAddonsOnly
      operator: Exists

# Node Configuration
# Node daemonset MUST run on all nodes (servers and workers) to handle volume mounts
node:
  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 256Mi
  # Tolerations for RKE2 server nodes (control-plane and etcd taints)
  # Required: CSI node pods must run on server nodes to mount volumes on pods scheduled there
  tolerations:
    - key: node-role.kubernetes.io/control-plane
      operator: Exists
      effect: NoSchedule
    - key: node-role.kubernetes.io/etcd
      operator: Exists
      effect: NoExecute
    - key: CriticalAddonsOnly
      operator: Exists

# RBAC
rbac:
  create: true

# Service Account
serviceAccount:
  create: true
  name: ""
