# Rancher Cluster on Proxmox

Deploy a complete Rancher management cluster and non-production apps cluster on Proxmox using Terraform with Ubuntu 24.04 cloud images, RKE2 Kubernetes, and automated Rancher installation.

## Features

- ✅ **Full Automation**: From VMs to Rancher in a single `terraform apply`
- ✅ **Cloud Image Provisioning**: Ubuntu 24.04 LTS cloud images with automatic downloads
- ✅ **Modern Provider**: bpg/proxmox v0.90 (1.7K+ GitHub stars, 130+ contributors)
- ✅ **RKE2 Kubernetes**: Automated RKE2 installation and cluster bootstrapping
- ✅ **Rancher Deployment**: Helm-based Rancher installation with cert-manager
- ✅ **High Availability**: 3-node manager + hybrid apps cluster (3 servers + workers) with HA Rancher
- ✅ **Cloud-Init Integration**: Automated networking, DNS, hostnames
- ✅ **Proxmox Guest Agent**: Automatic installation for better VM management
- ✅ **TrueNAS Storage**: Automated democratic-csi deployment with TrueNAS NFS
- ✅ **Comprehensive Docs**: Setup guides, variable management, troubleshooting
- ✅ **Secure Configuration**: API token auth, gitignore patterns, tfvars templates

## What's Deployed

- **Rancher Manager**: 3 VMs (401-403) with RKE2 + Rancher control plane
- **Apps Cluster**: Hybrid architecture
  - 3 Server nodes (404-406) - Control plane + etcd
  - 3 Worker nodes (407-409) - Application workloads (configurable)
- **Storage**: 
  - VM storage: Dedicated volumes (local-vm-zfs)
  - Persistent storage: TrueNAS NFS via democratic-csi (automated)
- **Network**: Static IPs, DNS configured via cloud-init
- **Kubernetes**: RKE2 clusters automatically bootstrapped and configured
- **Rancher**: Helm-deployed with cert-manager, Ingress, and bootstrap password
- **Storage Class**: TrueNAS NFS storage class (automatically created if configured)

## Requirements

### Local System Requirements

Your workstation/CI runner executing Terraform must have:

- **Terraform**: v1.5 or later
- **Git**: For version control and cloning this repository
- **SSH Client**: For VM authentication and access
- **curl**: For API testing and Proxmox verification
- **bash or zsh**: Shell environment (recommended for AI-assistant compatibility)
- **Internet access**: To download cloud images, RKE2, and Rancher
- **Git credentials**: Access to GitHub (public repository, no auth required)

**Optional but helpful:**
- `kubectl`: For post-deployment cluster management (can be retrieved from kubeconfig)
- `helm`: For manual Rancher customization (installed automatically during deployment)
- `jq`: For parsing JSON in scripts and debugging

### Proxmox Cluster Requirements

Your Proxmox VE cluster must have:

- **Proxmox VE 8.0+** with API token access
- **Resources**: 24 vCPU cores, 48GB RAM, 600GB storage minimum
- **Storage**: SSD/NVMe datastore (`local-vm-zfs` or similar) with qcow2 support
- **Networking**: VLAN 14 support, DHCP/static IP capability, internet access
- **DNS**: Access to 192.168.1.1 (local) or 1.1.1.1 (fallback)
- **API Token**: Required permissions listed in [API_TOKEN_AND_PERMISSIONS.md](docs/API_TOKEN_AND_PERMISSIONS.md)

### Network Requirements

**From local system:**
- Proxmox API (`https://<proxmox-ip>:8006`) and SSH
- Internet: github.com, get.rke2.io, cloud-images.ubuntu.com, docker.io, quay.io

**From Proxmox VMs:**
- Internet for RKE2 installer and container images
- Local DNS/Gateway (192.168.1.1 or equivalent)

### DNS Requirements

Rancher requires DNS records pointing to all 3 manager nodes for HA. DNS is configured at the node level via `/etc/resolv.conf` - CoreDNS automatically inherits node DNS configuration. See [DNS_CONFIGURATION_GUIDE.md](docs/DNS_CONFIGURATION_GUIDE.md) for complete DNS setup and [DNS_CONFIGURATION.md](docs/DNS_CONFIGURATION.md) for required DNS records.

### Supported Platforms

#### Proxmox Versions
- ✅ Proxmox VE 8.x (tested, recommended)
- ✅ Proxmox VE 9.x (tested, recommended)

#### Operating Systems
- ✅ Ubuntu 24.04 LTS (default, cloud image)
- ⚠️ Other Ubuntu versions supported (change cloud image URL in terraform.tfvars)

#### RKE2 Versions
- ✅ v1.34.3+rke2r1 (tested stable, default)
- ✅ Any specific RKE2 release tag (change `rke2_version` in terraform.tfvars)
- ❌ "latest" tag (not supported - must use specific version)

#### Other
- ✅ RKE2 v1.32+
- ✅ Rancher v2.7.x and v2.8.x
- ✅ containerd runtime
- ✅ QEMU/KVM hypervisor

### Unsupported

- Single-node Proxmox, non-QEMU hypervisors, bare metal
- Cloud deployments (Azure, AWS, GCP)
- Kubernetes upgrades, multi-cluster federation, Windows VMs

## Quick Start

### 1. Create Proxmox API Token

If you haven't already created an API token, follow the guide at [docs/API_TOKEN_AND_PERMISSIONS.md](docs/API_TOKEN_AND_PERMISSIONS.md). You'll need:
- **proxmox_api_url**: Your Proxmox endpoint
- **proxmox_api_user**: Usually `root@pam`
- **proxmox_api_token_id**: Token name (e.g., `terraform`)
- **proxmox_api_token_secret**: Token secret (generated by Proxmox)

### 2. Prepare Configuration

```bash
cd /home/lee/git/rancher-deploy/terraform
cp terraform.tfvars.example terraform.tfvars
```

Edit `terraform.tfvars` with your values:
```hcl
proxmox_api_url          = "https://pve.example.com:8006/api2/json"
proxmox_api_user         = "root@pam"
proxmox_api_token_id     = "terraform-token"
proxmox_api_token_secret = "your-secret-token"
proxmox_node             = "pve"
rke2_version             = "v1.34.3+rke2r1"  # IMPORTANT: use actual version, not "latest"
rancher_hostname         = "rancher.example.com"
rancher_password         = "your-secure-password"

# Optional: TrueNAS storage (automatically deploys democratic-csi if configured)
truenas_host             = "tn.example.com"
truenas_api_key          = "your-truenas-api-key"
truenas_dataset          = "/mnt/pool/dataset"
```

See `terraform/variables.tf` for all available options.

### 3. Deploy Infrastructure + Kubernetes

From the root directory:

```bash
# Deploy with automatic logging (recommended)
./scripts/apply.sh

# Or manually from terraform directory
cd terraform
terraform init
terraform plan
terraform apply -auto-approve
```

**Note**: `apply.sh` enables debug logging, saves to `terraform/terraform-<timestamp>.log`, deploys everything in ~35-40 minutes.

**⚠️ Important**:
- RKE2 version must be specific release (e.g., `v1.34.3+rke2r1`), not "latest"
- Ports 9345 (server) and 6443 (API) configured automatically
- If TrueNAS is configured, democratic-csi will be automatically deployed at the end of the plan

### 4. Verify Deployment

```bash
# Check manager Kubernetes cluster
export KUBECONFIG=~/.kube/rancher-manager.yaml
kubectl get nodes
kubectl get pods -n kube-system

# Check apps cluster
export KUBECONFIG=~/.kube/nprd-apps.yaml
kubectl get nodes
kubectl get pods -n kube-system

# Check storage class (if TrueNAS configured)
kubectl get storageclass

# Access Rancher
terraform output rancher_url
# Open in browser, login with:
# Username: admin
# Password: <from rancher_password in tfvars>
```

## Documentation

Complete documentation is available in the [docs/](docs/) folder. See [docs/README.md](docs/README.md) for full index.

### Quick Links

**Getting Started:**
- **[docs/DEPLOYMENT_GUIDE.md](docs/DEPLOYMENT_GUIDE.md)** - Complete deployment walkthrough
- **[docs/API_TOKEN_AND_PERMISSIONS.md](docs/API_TOKEN_AND_PERMISSIONS.md)** - Proxmox API token setup
- **[docs/DNS_CONFIGURATION.md](docs/DNS_CONFIGURATION.md)** - Required DNS records

**Storage:**
- **[docs/TRUENAS_STORAGE_SETUP.md](docs/TRUENAS_STORAGE_SETUP.md)** - Complete TrueNAS storage setup (automated via Terraform)
- **[docs/DEMOCRATIC_CSI_TRUENAS_SETUP.md](docs/DEMOCRATIC_CSI_TRUENAS_SETUP.md)** - Detailed democratic-csi with TrueNAS configuration guide

**Configuration:**
- **[docs/RANCHER_DOWNSTREAM_MANAGEMENT.md](docs/RANCHER_DOWNSTREAM_MANAGEMENT.md)** - Automatic cluster registration
- **[docs/CLOUD_IMAGE_SETUP.md](docs/CLOUD_IMAGE_SETUP.md)** - Cloud image provisioning
- **[docs/MODULES_AND_AUTOMATION.md](docs/MODULES_AND_AUTOMATION.md)** - Terraform modules and automation

**Troubleshooting:**
- **[docs/TROUBLESHOOTING.md](docs/TROUBLESHOOTING.md)** - Common issues and solutions

## Project Structure

```
.
├── scripts/                      # Helper scripts
│   ├── apply.sh                  # Deploy with automatic logging
│   ├── destroy.sh                # Destroy infrastructure
│   ├── create-rancher-api-token.sh # Create API token manually
│   ├── test-rancher-api-token.sh # Test API connectivity
│   ├── generate-helm-values-from-tfvars.sh # Generate Helm values from Terraform
│   └── install-democratic-csi.sh # Manual democratic-csi installation
├── helm-values/                  # Helm chart values
│   ├── democratic-csi-truenas.yaml # Generated (gitignored)
│   └── *.example                 # Example templates
├── README.md                     # This file
├── CHANGELOG.md                  # Version history
├── CODE_OF_CONDUCT.md            # Community guidelines
├── CONTRIBUTING.md               # Development guidelines
├── docs/                         # Complete documentation
│   ├── README.md                 # Documentation index
│   ├── DEPLOYMENT_GUIDE.md       # Complete deployment walkthrough
│   ├── TRUENAS_STORAGE_SETUP.md  # TrueNAS storage setup (consolidated)
│   └── ...                       # See docs/README.md for full list
└── terraform/                    # Terraform configuration
    ├── main.tf                   # Cluster definitions + democratic-csi deployment
    ├── provider.tf               # Provider configuration
    ├── variables.tf              # Variables (includes TrueNAS config)
    ├── outputs.tf               # Outputs (includes TrueNAS config)
    ├── terraform.tfvars.example  # Config template
    ├── terraform.tfvars         # Your config (gitignored)
    ├── fetch-token.sh            # RKE2 token helper
    └── modules/
        ├── proxmox_vm/           # VM creation module
        ├── rke2_manager_cluster/ # Manager verification
        └── rke2_downstream_cluster/ # Apps verification
```

## Key Features

### Reliable VM Creation

The deployment uses the **bpg/proxmox Terraform provider** (v0.90) with:
- ✅ Exponential backoff retry logic for API calls
- ✅ Proper task completion verification
- ✅ Comprehensive error handling
- ✅ Full Proxmox VE 8.x and 9.x support

### Automated Configuration

Each VM is automatically configured with:
- Cloud-init for OS customization
- Network settings (VLAN 14, static IP, DNS)
- Proxmox guest agent (qemu-guest-agent) for better VM management

### Storage Integration

- **TrueNAS Integration**: If configured in `terraform.tfvars`, democratic-csi is automatically deployed
- **Storage Class**: Created automatically at the end of Terraform plan
- **Secrets Management**: TrueNAS API keys stored in `terraform.tfvars` (gitignored)
- **Helm Values**: Auto-generated from Terraform variables

## Contributing

See [CONTRIBUTING.md](CONTRIBUTING.md) for development setup and code standards. See [CODE_OF_CONDUCT.md](CODE_OF_CONDUCT.md) for community standards.

## Changelog

See [CHANGELOG.md](CHANGELOG.md) for version history, features, and major changes.

## License

This project is licensed under the MIT License.

---

**Built with Claude Haiku 4.5** - This project was developed using Claude Haiku 4.5, an AI assistant optimized for code generation and infrastructure automation.
